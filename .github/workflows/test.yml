name: Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      lacylights-test-branch:
        description: 'Branch of lacylights-test to test'
        required: false
        default: 'main'
        type: string
      lacylights-go-branch:
        description: 'Branch of lacylights-go to test against'
        required: false
        default: 'main'
        type: string
      lacylights-fe-branch:
        description: 'Branch of lacylights-fe to test (future use)'
        required: false
        default: 'main'
        type: string
      lacylights-mcp-branch:
        description: 'Branch of lacylights-mcp to test (future use)'
        required: false
        default: 'main'
        type: string

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Display test configuration
        run: |
          echo "Testing configuration:"
          echo "  lacylights-test: ${{ github.event.inputs.lacylights-test-branch || github.ref_name }}"
          echo "  lacylights-go: ${{ github.event.inputs.lacylights-go-branch || 'main' }}"
          echo "  lacylights-fe: ${{ github.event.inputs.lacylights-fe-branch || 'main' }} (future use)"
          echo "  lacylights-mcp: ${{ github.event.inputs.lacylights-mcp-branch || 'main' }} (future use)"

      - name: Checkout test repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.lacylights-test-branch || github.ref }}

      - name: Checkout lacylights-go server
        uses: actions/checkout@v4
        with:
          repository: bbernstein/lacylights-go
          ref: ${{ github.event.inputs.lacylights-go-branch || 'main' }}
          path: lacylights-go
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: |
            go.sum
            lacylights-go/go.sum

      - name: Build lacylights-go server
        working-directory: lacylights-go
        run: |
          go mod download
          go build -o lacylights-go ./cmd/server

      - name: Start lacylights-go server
        working-directory: lacylights-go
        run: |
          ./lacylights-go &
          echo "Waiting for server to start..."
          # Wait up to 30 seconds for server to be ready
          for i in $(seq 1 30); do
            if curl -sf http://localhost:4001/graphql -X POST \
              -H "Content-Type: application/json" \
              -d '{"query":"{ __typename }"}' > /dev/null 2>&1; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i: Server not ready yet..."
            sleep 1
          done
          echo "Server failed to start after 30 seconds"
          exit 1
        env:
          PORT: "4001"
          ARTNET_ENABLED: "false"
          DATABASE_URL: "file:./test.db"

      - name: Run CI tests
        run: make test-ci
        env:
          GO_SERVER_URL: http://localhost:4001/graphql

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.lacylights-test-branch || github.ref }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: ./...
